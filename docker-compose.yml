volumes:
  postgres_storage:
  qdrant_storage:
  redis_data:

networks:
  demo:

# Base configuration for n8n (main + workers)
x-n8n: &service-n8n
  image: n8nio/n8n:latest
  environment:
    # Filesystem Mode
    - DB_TYPE=filesystem
    - N8N_FS_MODE=true
    - N8N_STORAGE_PATH=/home/node/.n8n

    # Secrets
    - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
    - N8N_USER_MANAGEMENT_JWT_SECRET=${N8N_USER_MANAGEMENT_JWT_SECRET}

    # Optional
    - N8N_DIAGNOSTICS_ENABLED=false
    - N8N_PERSONALIZATION_ENABLED=false
    - N8N_ENABLE_PYTHON_FUNCTIONS=true



services:

  # --------------------- POSTGRES (for your scripts only) ----------------------
  postgres:
    image: postgres:16-alpine
    hostname: postgres
    networks:
      - demo
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_storage:/var/lib/postgresql/data
    env_file:
      - .env.example


  # --------------------------- MAIN n8n INSTANCE -------------------------------
  n8n:
    <<: *service-n8n
    container_name: n8n
    networks:
      - demo
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_COMMUNITY_NODES_ENABLED=true
      - N8N_FEATURES_CHAT=true
      - DB_TYPE=filesystem
      - N8N_FS_MODE=true
      - N8N_STORAGE_PATH=/home/node/.n8n
      - N8N_EDITOR_BASE_URL=http://localhost:5678
    ports:
      - "5678:5678"
    volumes:
      - ./n8n:/home/node/.n8n


  # --------------------------- PGADMIN ----------------------------------------
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    networks:
      - demo
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8080:80"
    depends_on:
      - postgres

  # --------------------------- QDRANT -----------------------------------------
  qdrant:
    image: qdrant/qdrant
    networks:
      - demo
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage

  # --------------------------- REDIS ------------------------------------------
  redis:
    image: redis:alpine
    container_name: redis
    networks:
      - demo
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # --------------------------- WORKERS ----------------------------------------
  n8n-worker-1:
    <<: *service-n8n
    container_name: n8n-worker-1
    command: n8n worker
    networks:
      - demo
    volumes:
      - ./n8n:/home/node/.n8n
    depends_on:
      - redis

  n8n-worker-2:
    <<: *service-n8n
    container_name: n8n-worker-2
    command: n8n worker
    networks:
      - demo
    volumes:
      - ./n8n:/home/node/.n8n
    depends_on:
      - redis

  n8n-worker-3:
    <<: *service-n8n
    container_name: n8n-worker-3
    command: n8n worker
    networks:
      - demo
    volumes:
      - ./n8n:/home/node/.n8n
    depends_on:
      - redis

  n8n-worker-4:
    <<: *service-n8n
    container_name: n8n-worker-4
    command: n8n worker
    networks:
      - demo
    volumes:
      - ./n8n:/home/node/.n8n
    depends_on:
      - redis
