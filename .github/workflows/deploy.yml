name: Deploy n8n Docker Stack

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install rsync & ssh
      run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

    - name: Setup SSH key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Backup remote n8n folder
      run: |
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ secrets.SERVER_PATH }}/backups && cp -r ${{ secrets.SERVER_PATH }}/n8n ${{ secrets.SERVER_PATH }}/backups/n8n_$TIMESTAMP || true"

    - name: Sync files
      run: |
        rsync -avz -e "ssh -p ${{ secrets.SERVER_SSH_PORT }}" --delete \
          . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/

    - name: Restart docker-compose stack
      run: |
        ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          "cd ${{ secrets.SERVER_PATH }} && docker-compose pull && docker-compose up -d"
